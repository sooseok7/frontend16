"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.run = void 0;
const fs = require('fs-extra');
const path = require('path');
const glob = require('glob');
const _ = require('lodash');
const Cloudformation = require('./aws-utils/aws-cfn');
const { S3 } = require('./aws-utils/aws-s3');
const { downloadZip, extractZip } = require('./zip-util');
const { S3BackendZipFileName } = require('./constants');
const { fileLogger } = require('./utils/aws-logger');
const logger = fileLogger('initialize-env');
const amplify_cli_core_1 = require("amplify-cli-core");
const hooks_manager_1 = require("./utils/hooks-manager");
async function run(context, providerMetadata) {
    if (context.exeInfo && context.exeInfo.isNewEnv) {
        return context;
    }
    const amplifyDir = context.amplify.pathManager.getAmplifyDirPath();
    const tempDir = path.join(amplifyDir, '.temp');
    const currentCloudBackendDir = context.amplify.pathManager.getCurrentCloudBackendDirPath();
    const backendDir = context.amplify.pathManager.getBackendDirPath();
    const s3 = await S3.getInstance(context);
    const cfnItem = await new Cloudformation(context);
    const file = await downloadZip(s3, tempDir, S3BackendZipFileName);
    const unzippeddir = await extractZip(tempDir, file);
    fs.removeSync(currentCloudBackendDir);
    const cliJSONFiles = glob.sync(amplify_cli_core_1.PathConstants.CLIJSONFileNameGlob, {
        cwd: unzippeddir,
        absolute: true,
    });
    if (context.exeInfo.restoreBackend) {
        for (const cliJSONFilePath of cliJSONFiles) {
            const targetPath = path.join(amplifyDir, path.basename(cliJSONFilePath));
            fs.moveSync(cliJSONFilePath, targetPath, { overwrite: true });
        }
    }
    else {
        for (const cliJSONFilePath of cliJSONFiles) {
            fs.removeSync(cliJSONFilePath);
        }
    }
    fs.copySync(unzippeddir, currentCloudBackendDir);
    if (context.exeInfo.restoreBackend) {
        fs.removeSync(backendDir);
        fs.copySync(unzippeddir, backendDir);
    }
    fs.removeSync(tempDir);
    if (!context.exeInfo.pushHooks) {
        await hooks_manager_1.pullHooks(context);
    }
    logger('run.cfn.updateamplifyMetaFileWithStackOutputs', [{ StackName: providerMetadata.StackName }])();
    await cfnItem.updateamplifyMetaFileWithStackOutputs(providerMetadata.StackName);
    const currentAmplifyMeta = amplify_cli_core_1.stateManager.getCurrentMeta();
    const amplifyMeta = amplify_cli_core_1.stateManager.getMeta();
    Object.keys(amplifyMeta).forEach(category => {
        Object.keys(amplifyMeta[category]).forEach(resource => {
            if (currentAmplifyMeta[category] && currentAmplifyMeta[category][resource]) {
                amplifyMeta[category][resource].providerMetadata = currentAmplifyMeta[category][resource].providerMetadata;
            }
        });
    });
    let hasMigratedResources = false;
    const s3AmplifyMeta = amplify_cli_core_1.JSONUtilities.parse((await s3.getFile({
        Key: amplify_cli_core_1.PathConstants.AmplifyMetaFileName,
    })).toString());
    Object.keys(s3AmplifyMeta)
        .filter(k => k !== 'providers')
        .forEach(category => {
        Object.keys(s3AmplifyMeta[category]).forEach(resourceName => {
            const resource = s3AmplifyMeta[category][resourceName];
            if (resource.mobileHubMigrated === true) {
                _.set(amplifyMeta, [category, resourceName], resource);
                hasMigratedResources = true;
            }
        });
    });
    amplify_cli_core_1.stateManager.setMeta(undefined, amplifyMeta);
    if (hasMigratedResources) {
        amplify_cli_core_1.stateManager.setCurrentMeta(undefined, amplifyMeta);
    }
}
exports.run = run;
//# sourceMappingURL=initialize-env.js.map